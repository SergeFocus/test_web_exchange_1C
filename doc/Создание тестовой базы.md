Создание тестовой базы
======================
Для проверки успешности прохождения сценариев и тестов нам понадобится отдельная тестовая база, недоступная для других пользователей. Желательно, чтобы эта база была серверной.
- Во - первых, так вы сможете протестировать работу своего продукта в клиент- серверном варианте и обнаружить некоторые ошибки кодирования, которые неэаметны при испольэовании файловых баз. Например, передачу мутабельных значений с сервера на клиент.
- Во - вторых , сервер 1С : Предприятия позволяет управлять подключенными сеансами и разрывать их в случае необходимости.

На машине развернем сервер 1С: Предприятие и MSSQL сервер. 
Для тестирования мы можем использовать файловую базу, однако механизм отключения сеансов будет для нас недоступен. Пробному тестированию это не помешает - главное , что когда мы будем настраивать реальный разработческий контур, мы уже будем знать, как решить проблему с активными соединениями.

**Создадим новую базу 1С:**

- Назовем ее **test_bdd**.
- Укажем расположение- на сервере 1С:Предприятие.
- Кластер серверов располагается на **localhost** .
- Имя информационной базы - **test_bdd**.
- Тип СУБД - **MSSQL**, 
- Сервер баз данных также находится на **localhost**
- Имя базы данных, аналогично **test_bdd**.
- В качестве пользователя базы данных буду использовать стандартного пользователя **sa**.

Нажмем «Далее» и «Готово ». Тестовая база создана.

**Или используем скрипт:**
```
"C:\Program Files (x86)\1cv8\8.3.10.2252\bin\1cv8.exe" CREATEINFOBASE Srvr="localhost";Ref=test_bdd;DBMS=MSSQLServer;DBSrvr="localhost";DB=test_bdd;DBUID="sa";DBPwd="Qwe123$%^";CrSQLDB="Y";Locale=ru;SQLYOffs=2000 /AddInList " test_bdd "
```
Использование Deployka для обновления тестовой базы
===================================================

[github.com/oscript-library/deployka](https://github.com/oscript-library/deployka)

[Сервер администрирования кластера серверов 1C:Предприятия и deployka](https://infostart.ru/public/810752/)

В качестве инструмента автоматиэации обновления будем исnольэовать инструмент под названием **Deployka**. Это - nриложение для **OneScгipt**, которое можно установить с nомощью nакетного менеджера **opm**.

Откроем командную строку и наберем
```
opm install deployka
```
После установки из командной строки достуnно приложение **Deployka**. Если мы в командной строке вызовем `deployka` без параметров, мы увидим справку по продукту. Deployka умеет:
- Загружать конфигурацию из исходников, из cf, из cfu;
- Обновляться путем подключения к хранилищу;
- Управлять активными сеансами;
- И выполнять обновление конфигурации базы данных.

Тиnовой nроцесс обновления выглядит таким образом:
1. Сначала мы блокируем базу на вход для новых пользователей
2. И отключаем активных nольэователей
3. Обновляем основную конфигурацию
4. Потом nроиэводим обновление конфигурации базы данных
5. А после завершения обновления снимаем блокировку работы пользователей.

Данная последовательность может быть изменена. Например, для уменьшения времени неработоспособности базы вы можете сначала выполнить пункт обновления основной конфигурации, а только потом блокировать базу и выполнять обновление конфигурации базы данных.
Команда обновления базы конфигурацией из хранилища- `deployka loadrepo`

Начнем с самой главной команды - обновление базы конфигурацией из хранилища. Для этого в Deployka служит команда loadrepo. Получим справку по ней, выполнив команду 
```
deployka help loadrepo
```

```
C:>deployka help loadrepo
loadrepo - Обновить из хранилища подключенную базу
Параметры:
 <СтрокаПодключения> - Строка подключения к рабочему контуру
 <АдресХранилища> - Путь или сетевой адрес хранилища 1С
 -db-user - Пользователь информационной базы
 -db-pwd - Пароль пользователя информационной базы
 -storage-user - Пользователь хранилища конфигурации
 -storage-pwd - Пароль пользователя хранилища конфигурации
 -storage-ver - Версия (номер) закладки в хранилище - необязательно
 -v8version - Маска версии платформы 1С
 -uccode - Ключ разрешения запуска
```
Как следует из справки, у команды loadrepo есть:
- Два обязательных параметра :
    - Строка подключения к базе данных;
    - И адрес хранилища .
- А также несколько необязательных параметров:
    - `-db-user` и `-db-pwd` - логин и пароль пользователя информационной базы ;
    - `-storage-user` и `- storage-pwd` - логин и пароль пользователя хранилища ;
    - `-storage-ver`- номер той версии хранилища, которую мы хотим загрузить;
    - `-vBversion` - версия платформы;
    - И `-uccode` - ключ разрешения запуска, если была установлена блокировка входа пользователя.
Попробуем сформировать данную команду. Укажем 
```
deployka loadrepo "/Slocalhost\test_bdd" "tcp://192.168.60.247/KURS" -storage-user ci-bot -storage-pwd password
```

Где :
- Строку подключения мы формируем для серверной базы, поэтому в кавычках указываем :
    - `/S`
    - Имя сервера без пробела
    - И имя базы через обратный слэш.
- Следующий параметр-это адрес хранилища. Здесь в кавычках необходимо указать либо путь к каталогу, где располагается хранилище, либо сетевой путь. В нашем случае хранилище лежит по адресу `"tcp://192.168.60.247/KURS"`.  Для `F:\git_s\Kurs_1C\` пути - Заменим обратные слэши на прямые `F:/git_s/Kurs_1C/`.
- Пользователей в нашей информационной базе нет, поэтому параметры `dЬ-user` и` dЬ-pwd` нам не nонадобятся.
- В хранилище был создан служебный пользователь `ci-bot`. Укажем его параметры подключения через параметры `-storage-user` и `-storage-pwd`.
- Маску версии платформы 1С можно опустить.
- Ключ разрешения запуска также не будем указывать, так как наша база еще не заблокирована.

Выполним получившуюся команду. Наша конфигурация небольшая , поэтому данная команда выполнилась довольно быстро.

Зайдем в конфигуратор тестовой базы, чтобы убедиться, что обновление действительно выполнилось. Откроем 1С, выберем базу **test_bdd**)) и зайдем в режим конфигуратора. Видим, что конфигурация содержит справочники и документы и находится в состоянии необновленной конфигурации базы данных. Закроем конфигуратор и вернемся в командную строку.

Команда обновления конфигурации баэы данных - deployka dbupdate
===============================================================

После загрузки конфигурации нам необходимо выполнить обновление конфигурации базы данных . Получим справку по команде dbupdate. Выполним :
```
deployka help dbupdate
```
В данной команде нет пользователя и пароля хранилища конфигурации, нет адреса х ранилища, однако есть дополнительный необязательный параметр:
`-allow-warnings` (Разрешить предупреждения). Если его указать в строке запуска Deployka, предупреждения, появляющееся при обновлении конфигурации базы данных, будут игнорироваться. 

Напишем команду по обновлению конфигурации базы данных:
```
deployka dbupdate "/Slocalhost\test_bdd" -allow-warnings
```
Где :

- Строка подключения к серверной базе-`"/Slocalhost\test_bdd"`
- Пользователя и пароля у этой информационной базы нет.
- А вот флаг `-allow-warnings` (разрешить предупреждения) мы, пожалуй, передадим. 

Выполняем команду по обновлению конфигураций базы данных - в лагах видим информацию о новых измененных объектах и надпись о том, что обновление конфигурации базы данных успешно завершен.

Проверим это, запусти в нашу базу в режиме **1С:Предприятие**.

Откроем 1С, выберем базу «test_bdd», режим 1С:Предnриятие. Как можно убедиться, в интерфейсе появились объекты нашей конфигурации. Закроем 1С.

Возможности сервера 1С:Предприятия по управлению сеансами
=========================================================

Разберемся с управлением сеансами.

Для управления сеансами базы Deployka использует утилиты ras и rac (сервера и клиента администрирования кластера серверов). Схема работы- простая.
- На компьютере, где располагается сервер 1C, запускается также и служба ras - сервер админист рирования.
- На компьютере, где необходимо выnолнять действия no уnравлению сервером, зап ускается утилита rac- клиент администрирования с указанием nараметров подключения к серверу администрирования ras. 

В нашем случае и сервер и клиент будут расnолагаться на одной машине. В реальных условиях клиент администрирования необходимо доустановить. Обратите внимание, данные утилиты по ставляются вместе с дистрибутивом сервера 1С:Предприятие. Для получения клиентской утилиты на стороннем компьютере нужно будет установить сервер 1С:Предприятия, однако, запускать его не нужно.

Утилиты ras и rac располагаются там же, где и осн о вные запускаемые файлы 1С:Предприятие по пути `"С:\Program Files (х86)\1сv8\<КаталогСВерсиейПлатформы>\bin"`.

Утилиту ras (**сервер админи стрирования**) для удобства использования обычно запускают в режиме службы - это позволяет производить его автоматический запуск при старте системы и не держать постоянно открытым окно командной строки. Для создания новой службы вос nользуемся встроенной в Windows утилитой sc. Откроем командую строку от имени администратора и создадим новую службу:

- Вызовем приложение `sc`;
- Передадим ему команду `create` и начнем заполнять параметры данной команды;
- Первый параметр-это имя создаваемой службы- `"1С:Enterprise RAS"`;
- Далее необходимо указать путь к исполняемому файлу и его параметрам. Для этого служит параметр `binpath=" "`,он содержит знак «равно», после которого в кавычках указывается команда запуска нашей службы.
- Запускать мы будем утилиту `ras.ехе`, поэтому в кавычках укажем ее путь: `"C: \Program Files (х86)\1сv8\<Ка талогСВерсиейПлатформы>\bin\rаs .ехе"`

Так как путь содержит пробелы, его нужно обрамить дополнительными кавычками (для экранирования кавычек необходимо воспользоваться обратным слэшом) - добавим обратный слэш и еще одну кавычку в начале и в конце пути к утилите ras.
- Далее через пробел необходимо указать параметры, передаваемые утилите ras:
    - Для запуска в режиме сервиса используются параметры `cluster --service`
    - После этого необходимо указать порт, по которому будет отвечать сервис ras обычно устанавливается `port=l545`
    - Далее следует адрес сервиса 1С:Предприятие с указанием порта агента `localhost:1540`

В итоге у нас получится следующая строка запуска:
```
sc create "1С:Enterprise RAS" binpath="\"C:\Program Files(х86)\1Сv8\<КаталогСВерсиейПлатформы>\bin\rаs.ехе\ " cluster -serviceport= l545 localhost:1540"
```
Выполним данную команду и проверим, что наша служба действительно создалась. Откроем «Службы» и найдем службу "1С:Enterprise RAS". В свойствах службы установим тип запуска- «Автоматически», примен им изменения и нажмем кнопку «Запустить». Теперь мы можем администрировать наш сервер из командной строки.

Для проверки работы службы сервера администрирования выполним в командной строке команду получения информации о кластере:
```
"C: \Program Files (х86)\1сv8\<КаталогС ВерсиейПлатформы> \bin\rас .ехе" cluster list
```
- Укажем путь к утилите `rac`;
- И передадим ей в качестве аргумента команду `cluster list`.

Утилита `rac` подключилась к серверу администрирования, который по умолчанию располагается на `localhost:1545`, и получила информацию о кластере.

Возможности Deployka по управлению сеансами
===========================================

Вернемся к командной строке с `Deployka`- получим справку по команде `session`. Для этого выполним :
```
deployka help session
```

Команде `session` передается :
- Одно из действий :
    - **lock**- заблокировать,
    - **unlock**- разблокировать
    - **kill** - завершить сеансы
- И несколько не обязательных параметров :
    - - **rаs** - адресподключенияксерверу rаs (поумолчанию, **lосаlhоst:1545**)
    - - **rac** - путь расположения утилиты rac (по умолчанию, **в каталоге установки 1С**)
    - И др.

Команда блокировки сеансов- deployka session lock
=================================================

Попробуем заблокировать базу. Для этого выполним команду:
```
deployka session lock -ras localhost:l545 -db test_bdd -lockmessage " test" -lockuccode 123
```
- В параметре - ras укажем путь к серверу: `localhost: 1545`;
- Утилита rac должна определиться автоматически;
- В параметре - dи передается имя базы данных `test_bdd`;
- Пользователя информационной базы нет;
- Администратора кластера нет;
- В параметре `-lockmessage` установим сообщение блокировки `"test"`;
- И в параметре `-lockuccode` установим ключ разрешения запуска `"123"`.

Выполним команду. В логах отразилась информация по установке запрета соединений.

Если мы откроем 1С и попробуем подключиться к данной базе, то увидим наше сообщение о блокировке «test».

Команда завершения активных сеансов - deployka session kill
===========================================================

Для принудительного закрытия активных соединений используется команда kill:
```
deployka session kill-ras localhost:1545 -db test_bdd -lockmessage " test" lockuccode 123
```

Нам достаточно просто поменять `lock` на `kill` и все активные сеансы, которые были запущены в данный момент в базе, будут закрыты.

Команда разблокировки сеансов - deployka session unlock
=======================================================

Для снятия блокировки используется команда `unlock`.
```
deployka session unlock-ras localhost:1545 -db test_bdd -lockmessage "test" -lockuccode 123
```

При использовании команды `unlock` передавать параметры `-lockmessage` и `-lockuccode` необязательно.
